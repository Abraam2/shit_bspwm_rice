#!/usr/bin/env bash
# =============================================================
# BSPWM startup script - SANEADO Y OPTIMIZADO
# =============================================================

# --- Redirigir salida a log ---
exec > "$HOME/.config/bspwm/bspwm.log" 2>&1
set -x

# =============================================================
# ðŸ§© VARIABLES DE ENTORNO
# =============================================================
export QT_QPA_PLATFORMTHEME=qt6ct
export _JAVA_AWT_WM_NONREPARENTING=1
export GTK_USE_PORTAL=1
export XDG_CURRENT_DESKTOP=X-Cinnamon
export XDG_SESSION_TYPE=x11
export XDG_DESKTOP_PORTAL_DIR=/usr/share/xdg-desktop-portal/portals

# AÃ±adir scripts al PATH
export PATH="$HOME/.config/bspwm/scripts:$HOME/.config/rofi/scripts:$PATH"

# Cargar tema actual (Rice)
read -r RICETHEME < "$HOME/.config/bspwm/.rice"
export RICETHEME

# =============================================================
# ðŸ’» CONFIGURACIÃ“N BSPWM
# =============================================================
bspc monitor -d I II III IV V

bspc config external_rules_command "$HOME/.config/bspwm/scripts/ExternalRules"
bspc config automatic_scheme          alternate
bspc config initial_polarity          second_child
bspc config removal_adjustment        true
bspc config split_ratio               0.51
bspc config window_gap                10
bspc config single_monocle            true
bspc config borderless_monocle        false
bspc config gapless_monocle           false
bspc config focus_follows_pointer     true
bspc config pointer_follows_focus     false
bspc config pointer_follows_monitor   true
bspc config pointer_motion_interval   5
bspc config pointer_modifier          mod4
bspc config pointer_action1           move
bspc config pointer_action2           resize_side
bspc config pointer_action3           resize_corner

# Reglas especÃ­ficas
bspc rule -a Gsimplecal state=floating sticky=on rectangle=331x188+1487+60
bspc rule -a scratch sticky=on state=floating focus=on

# =============================================================
# âš™ï¸ SERVICIOS BÃSICOS
# =============================================================

# Teclado en espaÃ±ol
setxkbmap es &

# Cursor
export XCURSOR_THEME="Bibata-Modern-Ice"
export XCURSOR_SIZE=24
xsetroot -cursor_name left_ptr &
xrdb -merge <<< "Xcursor.theme: Bibata-Modern-Ice"
xrdb -merge <<< "Xcursor.size: 24"

# Evitar apagado de pantalla
xset s off -dpms &

# Agente de autenticaciÃ³n (Polkit)
if ! pgrep -x "polkit-gnome-au" > /dev/null; then
    /usr/lib/policykit-1-gnome/polkit-gnome-authentication-agent-1 &
fi

# Gnome Keyring
if command -v gnome-keyring-daemon >/dev/null; then
    eval $(gnome-keyring-daemon --start --components=pkcs11,secrets,ssh,gpg)
    export SSH_AUTH_SOCK
fi

# =============================================================
# ðŸŒ„ APARIENCIA Y PANTALLA
# =============================================================



feh --bg-fill "$HOME/Wallpapers/top 5 monkey.jpg" & 


# Redshift (Luz nocturna) - Comentado si da problemas en VM
redshift &

# Script de baterÃ­a
"$HOME/Scripts/aviso_baterÃ­a.sh" &

# =============================================================
# ðŸš€ LANZAMIENTO DE PROCESOS (Picom, Polybar, Sxhkd)
# =============================================================

# Limpiar procesos antiguos para evitar duplicados
killall -q picom sxhkd polybar dunst

# Esperar un pelÃ­n a que mueran
sleep 0.2

# 1. SXHKD (Teclado)
sxhkd -c "$HOME/.config/bspwm/sxhkdrc" &

# 2. DUNST (Notificaciones) - Importante cargarlo antes o junto al tema
# (Se suele lanzar en el theme-config.bash, pero por seguridad:)
# dunst -config "$HOME/.config/bspwm/dunstrc" & 

# 3. CARGAR TEMA (Colores, Picom y Polybar suelen ir aquÃ­)
# Este script 'theme-config.bash' suele lanzar Polybar y Picom.
# Si lo descomentas, NO lances picom/polybar abajo manualmente.
. "$HOME/.config/bspwm/rices/emilia/theme-config.bash"

# picom -b --config "$HOME/.config/bspwm/config/picom.conf" &
# bash "$HOME/.config/polybar/ghost/Bar.bash" &